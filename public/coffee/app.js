// Generated by CoffeeScript 1.10.0
(function() {
  var app, currentUser, storeCurrentUser;

  currentUser = function() {
    var email, store, token;
    store = new Sammy.Store({
      name: 'hereandalive',
      element: 'body',
      type: 'local'
    });
    token = store.get('auth_token');
    email = store.get('email');
    return {
      auth_token: token,
      email: email
    };
  };

  storeCurrentUser = function(email, auth_token) {
    var store, token;
    store = new Sammy.Store({
      name: 'hereandalive',
      element: 'body',
      type: 'local'
    });
    token = store.set('auth_token', auth_token);
    return email = store.set('email', email);
  };

  app = $.sammy("#main", function() {
    this.use("Haml");
    this.use("Session");
    this.get("#/", function(context) {
      var cu, template;
      context.app.swap('');
      template = "/templates/index.haml";
      cu = currentUser();
      if (cu.auth_token === "") {
        template = "/templates/index_unsigned.haml";
      }
      return context.render(template, {
        currentUser: cu
      }).appendTo(context.$element());
    });
    this.get("#/sign_out", function(context) {
      storeCurrentUser("", "");
      return context.redirect("#/");
    });
    this.post("#/sign_in/submit", function(context) {
      var email, hash, password;
      email = this.params['password'];
      password = this.params['email'];
      hash = {
        password: email,
        email: password
      };
      return $.ajax({
        type: "POST",
        url: "/api/sign_in",
        data: hash,
        dataType: "JSON"
      }).then((function(d1) {
        storeCurrentUser(email, d1['token']);
        return context.redirect("#/");
      }), (function(d1) {
        return $.ajax({
          type: "POST",
          url: "/api/sign_up",
          data: hash,
          dataType: "JSON"
        }).then((function() {
          return $.ajax({
            type: "POST",
            url: "/api/sign_in",
            data: hash,
            dataType: "JSON"
          }).then((function(d3) {
            storeCurrentUser(email, d3['token']);
            return context.redirect("#/");
          }), (function() {
            alert("Internal error while signing in after sign up");
            return context.redirect("#/");
          }), function() {
            console.log("D3 deferred");
            return context.redirect("#/");
          });
        }), (function() {
          alert("Error while sign up");
          return context.redirect("#/");
        }), function() {
          console.log("D2 deferred");
          return context.redirect("#/");
        });
      }), function() {
        console.log("D1 deferred");
        return context.redirect("#/");
      });
    });
    return this.get("#/profile", function(context) {
      var cu;
      cu = currentUser();
      return $.ajax({
        url: "api/profile",
        headers: {
          "X-Token": cu.auth_token
        }
      }).done(function(d) {
        console.log(d);
        context.app.swap('');
        return context.render("/templates/profile.haml", d).appendTo(context.$element());
      });
    });
  });

  $(function() {
    $('form').submit((function(_this) {
      return function() {
        return console.log(_this);
      };
    })(this));
    return app.run("#/");
  });

}).call(this);
