// Generated by CoffeeScript 1.10.0
(function() {
  var app, currentUser, storeCurrentUser;

  currentUser = function() {
    var email, store, token;
    store = new Sammy.Store({
      name: 'hereandalive',
      element: 'body',
      type: 'local'
    });
    token = store.get('auth_token');
    email = store.get('email');
    return {
      auth_token: token,
      email: email
    };
  };

  storeCurrentUser = function(email, auth_token) {
    var store, token;
    store = new Sammy.Store({
      name: 'hereandalive',
      element: 'body',
      type: 'local'
    });
    token = store.set('auth_token', auth_token);
    return email = store.set('email', email);
  };

  app = $.sammy("#main", function() {
    this.use("Haml");
    this.use("Session");
    this.get("#/", function(context) {
      var cu, template;
      context.app.swap('');
      template = "/templates/index.haml";
      cu = currentUser();
      if (cu.auth_token === "null" || cu.auth_token === null) {
        template = "/templates/index_unsigned.haml";
      }
      return context.render(template, {
        currentUser: cu
      }).appendTo(context.$element());
    });
    this.get("#/sign_out", function(context) {
      storeCurrentUser(null, null);
      return context.redirect("#/");
    });
    this.post("#/sign_in/submit", function(context) {
      var email, hash, password;
      email = this.params['email'];
      password = this.params['password'];
      hash = {
        password: password,
        email: email
      };
      return $.ajax({
        type: "POST",
        url: "/api/sign_in",
        data: hash,
        dataType: "JSON"
      }).done(function(d1) {
        storeCurrentUser(email, d1['token']);
        return context.redirect("#/");
      }).error(function(d1) {
        storeCurrentUser(null, null);
        return context.redirect("#/");
      });
    });
    this.post("#/sign_up/submit", function(context) {
      var email, hash, password;
      email = this.params['email'];
      password = this.params['password'];
      hash = {
        password: password,
        email: email
      };
      return $.ajax({
        type: "POST",
        url: "/api/sign_up",
        data: hash,
        dataType: "JSON"
      }).done((function(_this) {
        return function(d1) {
          return context.redirect("#/sign_up/after");
        };
      })(this)).error(function(d1) {
        return context.redirect("#/");
      });
    });
    this.get("#/sign_up/after", function(context) {
      context.app.swap('');
      return context.render("/templates/sign_up/after.haml").appendTo(context.$element());
    });
    this.get("#/profile", function(context) {
      var cu;
      cu = currentUser();
      return $.ajax({
        url: "/api/profile",
        headers: {
          "X-Token": cu.auth_token
        }
      }).then((function(d) {
        context.app.swap('');
        return context.render("/templates/users/private.haml", {
          resource: d
        }).appendTo(context.$element());
      }), (function() {
        storeCurrentUser(null, null);
        return context.redirect("#/");
      }), function() {
        console.log("Deferred");
        return context.redirect("#/");
      });
    });
    this.get("#/ping", function(context) {
      var cu;
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((function(position) {
          $("#lat").val(position.coords.latitude);
          $("#lon").val(position.coords.longitude);
          $("#accuracy").val(position.coords.accuracy);
          $("#altitude").val(position.coords.altitude);
          $("#altitudeAccuracy").val(position.coords.altitudeAccuracy);
          $("#heading").val(position.coords.heading);
          return $("#speed").val(position.coords.speed);
        }), (function(error) {
          return alert(error.message);
        }), {
          enableHighAccuracy: true,
          timeout: 5000
        });
      }
      cu = currentUser();
      context.app.swap('');
      return context.render("/templates/ping.haml").appendTo(context.$element());
    });
    this.post("#/ping/submit", function(context) {
      var cu, hash;
      cu = currentUser();
      hash = {
        accuracy: this.params.accuracy,
        altitude: this.params.altitude,
        altitudeAccuracy: this.params.altitudeAccuracy,
        heading: this.params.heading,
        lat: this.params.lat,
        lon: this.params.lon,
        place: this.params.place,
        speed: this.params.speed,
        source: "js",
        location: this.params.location
      };
      $.ajax({
        type: "POST",
        url: "/api/ping",
        data: hash,
        headers: {
          "X-Token": cu.auth_token
        },
        dataType: "JSON"
      }).then((function(d) {
        console.log(d);
        return context.redirect("#/ping/last");
      }), (function(d) {
        console.log("Error");
        return context.redirect("#/ping");
      }), function() {
        console.log("Deferred");
        return context.redirect("#/ping");
      });
      return console.log(hash);
    });
    this.get("#/u/:public_handle", function(context) {
      console.log(context);
      return $.ajax({
        url: "/api/u/" + context.params.public_handle
      }).then((function(d) {
        console.log(d);
        context.app.swap('');
        return context.render("/templates/users/public.haml", {
          resource: d
        }).appendTo(context.$element());
      }), (function() {
        return context.redirect("#/");
      }), function() {
        console.log("Deferred");
        return context.redirect("#/");
      });
    });
    this.get("#/ping/last", function(context) {
      var cu;
      cu = currentUser();
      return $.ajax({
        url: "/api/ping/last",
        headers: {
          "X-Token": cu.auth_token
        }
      }).then((function(d) {
        console.log(d);
        context.app.swap('');
        return context.render("/templates/ping_show.haml", {
          resource: d
        }).appendTo(context.$element());
      }), (function() {
        return context.redirect("#/");
      }), function() {
        console.log("Deferred");
        return context.redirect("#/");
      });
    });
    return this.get("#/ping/route", function(context) {
      var cu;
      cu = currentUser();
      return $.ajax({
        url: "/api/ping",
        headers: {
          "X-Token": cu.auth_token
        }
      }).then((function(d) {
        console.log(d);
        context.app.swap('');
        return context.render("/templates/ping_index.haml", {
          collection: d
        }).appendTo(context.$element());
      }), (function() {
        return context.redirect("#/");
      }), function() {
        console.log("Deferred");
        return context.redirect("#/");
      });
    });
  });

  $(function() {
    $('form').submit((function(_this) {
      return function() {
        return console.log(_this);
      };
    })(this));
    return app.run("#/");
  });

}).call(this);
